name: Trigger Workflows in Sequence

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'  # 每20分钟触发一次（每小时的第0、20、40分钟）

jobs:
  trigger_adblock_reject_json:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Run_Adblock_Reject_JSON.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          repo="${{ github.repository }}"
          workflow="Run_Adblock_Reject_JSON.yml"
          
          echo "Triggering $workflow on $repo..."
          gh workflow run "$workflow" --ref main --repo "$repo"
          
          sleep 15  # 稍延长等待时间，确保 run 出现
          
          run_id=$(gh run list --repo "$repo" --workflow="$workflow" --branch main --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [ -z "$run_id" ]; then
            echo "Error: Failed to retrieve the triggered run ID."
            exit 1
          fi
          
          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --repo "$repo" --exit-status

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_adblock_reject_domain_txt:
    needs: trigger_adblock_reject_json
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Run_Adblock_Reject_DOMAIN_TXT.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          repo="${{ github.repository }}"
          workflow="Run_Adblock_Reject_DOMAIN_TXT.yml"
          
          echo "Triggering $workflow on $repo..."
          gh workflow run "$workflow" --ref main --repo "$repo"
          
          sleep 15
          
          run_id=$(gh run list --repo "$repo" --workflow="$workflow" --branch main --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [ -z "$run_id" ]; then
            echo "Error: Failed to retrieve the triggered run ID."
            exit 1
          fi
          
          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --repo "$repo" --exit-status

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_convert_ruleset_json_to_srs:
    needs: trigger_adblock_reject_domain_txt
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Convert_Ruleset_JSON_to_SRS.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          repo="${{ github.repository }}"
          workflow="Convert_Ruleset_JSON_to_SRS.yml"
          
          echo "Triggering $workflow on $repo..."
          gh workflow run "$workflow" --ref main --repo "$repo"
          
          sleep 15
          
          run_id=$(gh run list --repo "$repo" --workflow="$workflow" --branch main --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [ -z "$run_id" ]; then
            echo "Error: Failed to retrieve the triggered run ID."
            exit 1
          fi
          
          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --repo "$repo" --exit-status

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_release_adblock_file:
    needs: trigger_convert_ruleset_json_to_srs
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Release_ADblock_File.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          repo="${{ github.repository }}"
          workflow="Release_ADblock_File.yml"
          
          echo "Triggering $workflow on $repo..."
          gh workflow run "$workflow" --ref main --repo "$repo"
          
          sleep 15
          
          run_id=$(gh run list --repo "$repo" --workflow="$workflow" --branch main --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [ -z "$run_id" ]; then
            echo "Error: Failed to retrieve the triggered run ID."
            exit 1
          fi
          
          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --repo "$repo" --exit-status
