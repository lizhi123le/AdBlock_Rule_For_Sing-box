name: Trigger Workflows in Sequence

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'  # 每20分钟触发一次（每小时的第0、20、40分钟）

jobs:
  trigger_adblock_reject_json:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Run_Adblock_Reject_JSON.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}  # 使用你的 PAT（secrets.TOKEN）
        run: |
          workflow="Run_Adblock_Reject_JSON.yml"
          echo "Triggering $workflow..."
          gh workflow run "$workflow" --ref main

          # 短暂等待 run 出现（通常几秒即可）
          sleep 10

          # 获取最新 run ID（刚触发的应该是最新的）
          run_id=$(gh run list --workflow="$workflow" --branch=main --limit=1 --json databaseId -q '.[0].databaseId')

          if [ -z "$run_id" ]; then
            echo "Error: Failed to get the triggered run ID."
            exit 1
          fi

          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --exit-status  # 如果失败，自动退出非0码，导致 job 失败

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_adblock_reject_domain_txt:
    needs: trigger_adblock_reject_json
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Run_Adblock_Reject_DOMAIN_TXT.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          workflow="Run_Adblock_Reject_DOMAIN_TXT.yml"
          echo "Triggering $workflow..."
          gh workflow run "$workflow" --ref main

          sleep 10

          run_id=$(gh run list --workflow="$workflow" --branch=main --limit=1 --json databaseId -q '.[0].databaseId')

          if [ -z "$run_id" ]; then
            echo "Error: Failed to get the triggered run ID."
            exit 1
          fi

          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --exit-status

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_convert_ruleset_json_to_srs:
    needs: trigger_adblock_reject_domain_txt
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Convert_Ruleset_JSON_to_SRS.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          workflow="Convert_Ruleset_JSON_to_SRS.yml"
          echo "Triggering $workflow..."
          gh workflow run "$workflow" --ref main

          sleep 10

          run_id=$(gh run list --workflow="$workflow" --branch=main --limit=1 --json databaseId -q '.[0].databaseId')

          if [ -z "$run_id" ]; then
            echo "Error: Failed to get the triggered run ID."
            exit 1
          fi

          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --exit-status

      - name: Wait 90 seconds before next
        run: sleep 90

  trigger_release_adblock_file:
    needs: trigger_convert_ruleset_json_to_srs
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for Release_ADblock_File.yml
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          workflow="Release_ADblock_File.yml"
          echo "Triggering $workflow..."
          gh workflow run "$workflow" --ref main

          sleep 10

          run_id=$(gh run list --workflow="$workflow" --branch=main --limit=1 --json databaseId -q '.[0].databaseId')

          if [ -z "$run_id" ]; then
            echo "Error: Failed to get the triggered run ID."
            exit 1
          fi

          echo "Waiting for run $run_id to complete..."
          gh run watch "$run_id" --exit-status
