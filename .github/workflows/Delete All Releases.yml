name: Delete Old Releases (Keep Latest 3)

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 */3 * * *'  # 每3小时执行一次

jobs:
  cleanup-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 删除 releases 需要 write 权限
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete draft releases (stable with external jq)
        run: |
          # 获取所有 draft release 的 tag 名称，使用外部 jq 过滤
          drafts=$(gh release list --limit 100 --json tagName,isDraft | jq -r '.[] | select(.isDraft==true) | .tagName')

          if [ -z "$drafts" ]; then
            echo "No draft releases found, skipping."
          else
            count=0
            while IFS= read -r tag; do
              echo "Attempting to delete draft release with tag: $tag"
              if gh release view "$tag" >/dev/null 2>&1; then
                gh release delete "$tag" -y
                echo "Deleted draft release with tag: $tag"
                count=$((count+1))
              else
                echo "Skip: $tag not found"
              fi
            done <<< "$drafts"
            echo "Total draft releases deleted: $count"
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Delete older releases (keep latest 3)
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3  # 保留最新的 3 个 releases
          delete_tags: false  # 是否同时删除关联的 tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
